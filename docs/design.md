# SageMaker Canvas時系列モデル分析ダッシュボード 設計書

## 要件定義書

### 目的
Amazon SageMakerのCanvasで作成した時系列モデルから出力された結果を使用して、SKUごとに説明可能な指標を出力するダッシュボードを作成する。

### 要件
1. データ概要と評価指標の表示
   - 選択した商品のデータ概要（商品名、期間、レコード数）
   - モデル評価指標（RMSE、MAE、MAPE）

2. 時系列可視化
   - 日次売上高の実績vs予測グラフ（最新30日分）
   - 特徴量重要度のグラフ
   - 特徴量の部分依存（重要度が高い特徴量3つ）

3. 需要要因分析
   - 需要変動要因の円グラフ

4. 交互作用効果
   - 主要な交互作用効果の視覚化と解釈

5. 異常検出
   - 標準偏差の2倍を超える誤差を持つデータポイントのテーブル表示

### 入力データ
- 学習データ：`data/train/SKU_rev_train.csv`
- テストデータ：`data/test/SKU需要予測_test.csv`
- 出力（予測）結果：`data/result/result_summary.csv`

### 商品IDと商品名のマッピング
- 0: カップラーメン しお
- 1: ハイチュウ グレープ
- 2: ポテトチップス コンソメパンチ

## 設計書

### 概略設計

ダッシュボードは以下のコンポーネントで構成されます：

1. **データ読み込みコンポーネント**
   - 学習データ、テストデータ、予測結果を読み込み、前処理を行う

2. **指標計算コンポーネント**
   - RMSE、MAE、MAPEなどの評価指標を計算する

3. **可視化コンポーネント**
   - 時系列データの可視化
   - 特徴量重要度の可視化
   - 特徴量の部分依存の可視化
   - 需要要因分析の可視化
   - 交互作用効果の可視化
   - 異常検出の可視化

4. **ユーザーインターフェースコンポーネント**
   - 商品選択
   - 期間選択
   - 表示日数選択

### 機能設計

#### データ読み込み機能
- 学習データ、テストデータ、予測結果を読み込む
- 日付列を日付型に変換
- 学習データとテストデータを結合
- 予測結果をマージ

#### 指標計算機能
- RMSE（Root Mean Squared Error）の計算
- MAE（Mean Absolute Error）の計算
- MAPE（Mean Absolute Percentage Error）の計算
- 過剰在庫率の計算
- 欠品率の計算

#### 特徴量重要度計算機能
- 特徴量と売上の相関係数を計算
- 相関係数の絶対値を重要度として使用
- 重要度を0-1の範囲に正規化

#### 異常検出機能
- 実績値と予測値の差（残差）を計算
- 残差の平均と標準偏差を計算
- 標準偏差の2倍を超える残差を持つデータポイントを異常値として検出

#### 交互作用効果計算機能
- 特徴量ペアごとに交互作用効果を計算
- 交互作用効果の大きさでソート
- 上位の交互作用効果を視覚化

#### ユーザーインターフェース機能
- サイドバーに商品選択ドロップダウンを表示
- サイドバーに期間選択スライダーを表示
- 時系列可視化セクションに表示日数選択スライダーを表示

### クラス構成

#### データ処理クラス
- `load_data()`: データの読み込みと前処理を行う関数
- `calculate_metrics()`: 評価指標を計算する関数
- `get_feature_importance()`: 特徴量重要度を計算する関数
- `detect_anomalies()`: 異常値を検出する関数
- `calculate_interactions()`: 交互作用効果を計算する関数

#### 可視化クラス
- `plot_sales_prediction()`: 売上予測と実績のプロット関数
- `plot_partial_dependence()`: 特徴量の部分依存プロット関数
- `plot_demand_factors()`: 需要変動要因の円グラフ関数
- `plot_interactions()`: 交互作用効果の可視化関数
- `plot_price_marketing_interaction()`: 価格とマーケティングの交互作用グラフ関数

#### メインアプリケーションクラス
- `main()`: アプリケーションのメイン関数

## 実装詳細

### 使用技術
- **言語**: Python 3.10
- **フレームワーク**: Streamlit 1.31.0
- **データ処理**: Pandas 2.1.0, NumPy 1.24.3
- **可視化**: Plotly 5.18.0, Matplotlib 3.7.1, Seaborn 0.12.2
- **機械学習**: scikit-learn 1.3.0

### ファイル構成
- `app/streamlit_app.py`: メインアプリケーションファイル
- `app/requirements.txt`: 依存ライブラリリスト
- `data/train/SKU_rev_train.csv`: 学習データ
- `data/test/SKU需要予測_test.csv`: テストデータ
- `data/result/result_summary.csv`: 予測結果

### 実行方法
1. 依存ライブラリのインストール: `pip install -r app/requirements.txt`
2. アプリケーションの実行: `cd app && streamlit run streamlit_app.py`